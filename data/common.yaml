organization_domain: studentspex.se
smtp_host: smtp.eu.mailgun.org
smtp_user: postmaster@studentspex.se
smtp_port: 465
keycloak_auth_url: https://%{lookup('keycloak_liss::domain')}/auth

nginx::server_purge: true

keycloak::version: '9.0.2'
keycloak::datasource_driver: postgresql
keycloak::datasource_dbname: keycloak
keycloak::datasource_username: keycloak
keycloak::proxy_https: true
keycloak::realms_merge: true
keycloak::realms:
    master:
        remember_me: false
        smtp_server_auth: true
        smtp_server_from_display_name: 'Spexets internsidor'
        smtp_server_from: root@%{organization_domain}
        smtp_server_host: "%{smtp_host}"
        smtp_server_password: "%{lookup('smtp_password')}"
        smtp_server_port: "%{smtp_port}"
        smtp_server_ssl: true
        smtp_server_starttls: true
        smtp_server_user: "%{smtp_user}"
    liss:
        display_name: 'Link√∂pings Studentspex'
        internationalization_enabled: true
        login_theme: liss
        remember_me: true
        smtp_server_auth: true
        smtp_server_from_display_name: 'Spexets internsidor'
        smtp_server_from: root@%{organization_domain}
        smtp_server_host: "%{smtp_host}"
        smtp_server_password: "%{lookup('smtp_password')}"
        smtp_server_port: "%{smtp_port}"
        smtp_server_ssl: true
        smtp_server_starttls: true
        smtp_server_user: "%{smtp_user}"
        sso_session_idle_timeout: 604800 # Must visit at least once per week to not expire
        sso_session_max_lifespan: 2592000 # Must re-login after 30 days
        supported_locales:
            - sv
            - en

keycloak_liss::batadas_userlookup_url: https://internt.%{organization_domain}/batadasen/api
keycloak_liss::domain: konto.%{organization_domain}

internsidor::domain: internt.%{organization_domain}
internsidor::gunicorn_port: 8087
internsidor::milter_port: 8082
internsidor::recipient_lookup_port: 9999
internsidor::debug: false

base::cron::daily_hour: 3
base::cron::daily_minute: 55

legacy::domain: old.%{organization_domain}
legacy::spexflix_domain: spexflix.%{organization_domain}

mysql::server::remove_default_accounts: true

mediawiki::domain: wiki.%{organization_domain}
mediawiki::baseurl: https://%{lookup('mediawiki::domain')}
mediawiki::version_major_minor: '1.34'
mediawiki::version_patch: '2'

php::fpm::settings:
    PHP/post_max_size: '100M'
    PHP/upload_max_filesize: '50M'
    Date/date.timezone: 'Europe/Stockholm'

postfix::parameters:
    myorigin: "%{organization_domain}"
    mydestination: "$myhostname localhost %{organization_domain}"
    smtpd_relay_restrictions: permit_mynetworks defer
    mynetworks:
        comments:
            - Allow mail from SUNET email filters
        value: 127.0.0.0/8 192.36.171.200/29 89.45.235.0/28 [2001:6b0:8:2::]/64 [2001:6b0:5a:4019::]/64

    smtpd_milters:
        comments:
            - Milter that checks for authorized senders to protected lists and rewrites some subject headers
        value: inet:localhost:%{lookup('internsidor::milter_port')}
    
    alias_maps: hash:/etc/aliases

    virtual_alias_maps:
        comments:
            - Connects to a daemon that performs a lookup against the database of email lists recipients
        value: socketmap:inet:localhost:%{lookup('internsidor::recipient_lookup_port')}:virtual

    relayhost: "%{smtp_host}:%{smtp_port}"
    smtp_sasl_auth_enable: 'yes'
    smtp_sasl_security_options: noanonymous
    smtp_tls_security_level: encrypt
    smtp_tls_wrappermode: 'yes'
    smtp_sasl_password_maps: "static:%{lookup('smtp_user')}:%{lookup('smtp_password')}"

letsencrypt::email: root@dev.studentspex.se

unattended_upgrades::auto:
    reboot: true
    reboot_time: '04:41'
unattended_upgrades::mail:
    only_on_error: true
    to: root@dev.studentspex.se
unattended_upgrades::verbose: 1

# Configure the firewall
firewalld::services:
    http:
        ensure: present
    https:
        ensure: present
    ssh:
        ensure: present
    smtp:
        ensure: present
